---
title: "Data Carpentry in R - exercises"
output: 
  slidy_presentation:
    incremental: false
    highlight: monochrome
    df_print: kable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
surveys <- read_csv("https://ndownloader.figshare.com/files/2292169")
```


----

## Ex 1

* How many animals were caught in each `plot_type` surveyed?
* Make a summary table with the mean, minimum and maximum hindfoot length of each.
Include the total number of individuals observed as well as the number of those 
individuals that had data for this variable.
* What was the heaviest animal measured in each year? Return the columns `year`, 
`genus`, `species_id` and `weight`.


----

## Ex 2

* Create a new data frame called `surveys_complete`, which:
    * has no missing values for `weight`, `hindfoot_length` and `sex`
    * contains only species that were measured in at least 50 individuals

```{r, echo=FALSE}
surveys_complete <- surveys %>% 
  filter(!is.na(weight) & !is.na(sex) & !is.na(hindfoot_length))

common_species <- surveys_complete %>% 
  count(species_id) %>% 
  filter(n >= 50)

surveys_complete <- surveys_complete %>% 
  filter(species_id %in% common_species$species_id)
```

The final data frame should have `r nrow(surveys_complete)` rows.


----

## Ex 3

Boxplots are useful summaries, but hide the shape of the distribution. 
For example, if the distribution is bimodal, we would not see it in a boxplot. 
An alternative to the boxplot is the violin plot, where the shape 
(of the density of points) is drawn.

* Use `geom_violin()` to create violin plots of weight distributions for each `genus`
* Some individuals are much heavier than others. Using a log scale in this case would help.
Try adding a "scale" layer with `scale_y_log10()`. 
* Can you overlay a boxplot with outliers removed (check `?geom_boxplot` help)?
* Try and recreate the picture below, showing the distribution of weights by `species_id`,
with violin plots coloured by `genus`.

```{r, echo = FALSE}
surveys_complete %>% 
  ggplot(aes(species_id, weight)) +
  geom_violin(aes(fill = genus)) +
  geom_boxplot(width = 0.2, outlier.shape = NA) +
  scale_y_log10()
```

----

## Ex 4

Make a visual representation of the number of observations we have of each genus 
in each plot type. (hint: try the `size` aesthetic with `geom_point()`)

```{r, echo = FALSE}
surveys_complete %>% 
  ggplot(aes(genus, plot_type)) +
  geom_count() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Genus", y = "Plot Type")
```


----

## Ex 5

We want to explore if the species diversity (number of different species) changed 
across the years in different plot treatments (`plot_type`). 

* Make a new table called `yearly_diversity`, with the number of _distinct_ 
`species_id` sampled in each year and plot type. 
(hint: see the function `n_distinct()` to use inside the `summarise()` function)
* Using the new table, try and reproduce the plot below
* Update your summary table by also including information about sex (i.e. species 
diversity per `year`, `plot_type` and `sex`). Can you think of ways to change 
your previous plot to also visualise this extra information?

```{r, echo = FALSE}
surveys_complete %>% 
  group_by(year, plot_type) %>% 
  summarise(n_species = n_distinct(species_id)) %>% 
  ggplot(aes(year, n_species)) +
  geom_line(aes(colour = plot_type)) +
  labs(colour = "Plot Type", x = "Year", y = "# species")
```

----

## Ex 6

* Using your `yearly_diversity` table, recreate the plot below.
* Can you change the order of the panels so that M appears on top?

```{r, echo = FALSE}
yearly_diversity <- surveys_complete %>% 
  group_by(year, sex, plot_type) %>% 
  summarise(n_species = n_distinct(species_id))

yearly_diversity %>% 
  ggplot(aes(year, n_species)) +
  geom_line(aes(colour = plot_type)) +
  labs(colour = "Plot Type", x = "Year", y = "# species") +
  facet_grid(sex ~ .)
```


----

## Ex 7

Use line plots to help you explore these questions:

* How did the average weight of all species change across the years?
* Was it different for males and females? 
* What about between different `plot_type`? (hint: use facetting to help you)

```{r, eval=FALSE, echo=FALSE}
surveys_complete %>% 
  group_by(year, sex, plot_type) %>% 
  summarise(mean_wgt = mean(weight, na.rm = TRUE)) %>% 
  ggplot(aes(year, mean_wgt, colour = sex)) +
  geom_line() + geom_point() + facet_wrap(~ plot_type) +
  labs(x = "Year", y = "Average biomass (g)")
```

* Bonus: Try and add a "ribbon" which shows the mean +/- 2*SEM (standard error of 
the mean, calculated as the standard deviation divided by the square root of the 
number of observations)

```{r}
surveys_complete %>% 
  group_by(year, sex, plot_type) %>% 
  summarise(mean_wgt = mean(weight),
            sd_wgt = sd(weight),
            n = n(),
            se_wgt = sd_wgt/sqrt(n)) %>% 
  ggplot(aes(year, mean_wgt, colour = sex)) +
  geom_ribbon(aes(ymin = mean_wgt - 2*se_wgt, ymax = mean_wgt + 2*se_wgt, fill = sex), 
              alpha = 0.3, colour = NA) +
  geom_line() + 
  facet_wrap( ~ plot_type) +
  labs(x = "Year", y = "Average biomass (g)")
```


----

## Ex 8

* Make a scatterplot to explore the correlation between average male and female 
weights per species in each `plot_type` surveyed. (hint: add a x=y identity line 
using `geom_abline()`)

```{r, echo=FALSE, warning=FALSE}
surveys %>% 
  filter(!is.na(weight) & !is.na(sex)) %>% 
  group_by(species_id, plot_type, sex) %>% 
  summarise(mean_wgt = mean(weight)) %>% 
  ungroup() %>% 
  spread(sex, mean_wgt) %>% 
  ggplot(aes(M, F)) +
  geom_abline(linetype = 2) +
  geom_point(aes(colour = factor(plot_type))) +
  scale_x_log10() + scale_y_log10() +
  labs(x = "Male", y = "Female", colour = "Plot type")
```


----

## Ex 9

* Make a boxplot similar to the one below, showing the hindfoot length distribution, 
with the x-axis sorted by mean weight. 
(hint: create a colum with the mean weight per species and then use the function 
`reorder()` to factorise the x-axis variable)

```{r, echo=FALSE}
surveys_complete %>% 
  group_by(species_id) %>% 
  mutate(mean_weight = mean(weight)) %>% 
  ungroup() %>% 
  mutate(species_id = reorder(species_id, mean_weight)) %>% 
  ggplot(aes(species_id, hindfoot_length)) +
  geom_boxplot(aes(fill = log10(mean_weight))) +
  scale_fill_viridis_c()
```

----

## Ex 10

In a publication from [Ernest et al. 2017](https://www.journals.uchicago.edu/doi/10.1086/592402) 
some species where classified according to their habitat preferences. 

Read this information into your R session using the following command:

```
habitat_pref <- read_csv("https://raw.githubusercontent.com/tavareshugo/data_carpentry_extras/master/slides_with_exercises/species_habitat_affinities_Ernest2017.csv")
```

```{r, message=FALSE}
habitat_pref <- read_csv("https://raw.githubusercontent.com/tavareshugo/data_carpentry_extras/master/slides_with_exercises/species_habitat_affinities_Ernest2017.csv")
```

* How many of these species are contained in your `surveys_complete` dataset? (hint: 
the function `paste()` might be useful)

```{r, eval=FALSE}
sum(habitat_pref$species %in% paste(surveys_complete$genus, surveys_complete$species))
```

* Make a boxplot like the one below, showing the weight distribution of each 
species that has habitat affinity information. (hint: look at the help for 
`?facet_grid` to see how to make the panels scales and spacing adjust to the 
data)

```{r}
surveys_complete %>% 
  mutate(species_name = paste(genus, species)) %>% 
  inner_join(habitat_pref, by = c("species_name" = "species")) %>% 
  ggplot(aes(species_id, weight)) +
  geom_boxplot(aes(fill = genus)) +
  facet_grid(sex ~ habitat, scale = "free_x", space = "free_x") +
  scale_y_log10()
```


----

## Ex 11

* Plot the change in abundance across the years for species with different habitat 
affinities (include those species with no habitat information as well). 
    * Abundance = number of individuals per hectare
    * Each plot is 0.25ha

(don't worry too much about getting the exact look of the graph below. But if you
do want to get a similar look, try and do some web search! E.g. "how to change 
legend position in ggplot2")

```{r}
surveys_complete %>% 
  mutate(species_name = paste(genus, species)) %>% 
  left_join(habitat_pref, by = c("species_name" = "species")) %>% 
  group_by(year, habitat) %>% 
  summarise(abundance = n()/(0.25*n_distinct(plot_id))) %>% 
  ggplot(aes(year, abundance)) +
  geom_line(aes(colour = habitat)) +
  labs(x = "Year", y = "Abundance (# individuals/ha)", colour = "Habitat preference") +
  scale_colour_viridis_d(na.value = "grey") +
  theme_classic() +
  theme(legend.position = c(0, 1), legend.justification = c(0, 1))
```


